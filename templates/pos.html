{% extends "base.html" %}

{% block title %}POS - Point of Sale{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">POS</li>
{% endblock %}

{% block content %}
<!-- Hidden element to pass data to JavaScript -->
<div id="page-data" data-action="{{ action }}" data-has-held="{{ 'true' if held_transactions else 'false' }}" style="display: none;"></div>

<div class="row">
    <!-- Products Section -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Products</h5>
                <div class="input-group" style="width: 350px;">
                    <input type="text" class="form-control" id="product-search" placeholder="Search by name, SKU, or barcode..." value="{{ search }}">
                    <button class="btn btn-outline-secondary" type="button" id="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="clear-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="products-grid">
                    {% for product in products %}
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card product-card h-100" data-product-id="{{ product.id }}" data-price="{{ product.price }}" data-name="{{ product.name }}">
                            <div class="card-body text-center">
                                {% if product.image %}
                                <img src="{{ url_for('static', filename='uploads/products/' + product.image) }}" class="card-img-top mb-2" style="height: 100px; object-fit: cover;" alt="{{ product.name }}">
                                {% else %}
                                <div class="bg-light d-flex align-items-center justify-content-center mb-2" style="height: 100px;">
                                    <i class="fas fa-box fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                <h6 class="card-title">{{ product.name }}</h6>
                                <p class="card-text text-primary fw-bold">${{ "%.2f"|format(product.price) }}</p>
                                <button class="btn btn-primary btn-sm add-to-cart" data-product-id="{{ product.id }}">
                                    <i class="fas fa-plus me-1"></i>Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Cart & Checkout Section -->
    <div class="col-lg-4">
        <!-- Customer Selection -->
        <div class="card shadow mb-3">
            <div class="card-header">
                <h6 class="mb-0">Customer</h6>
            </div>
            <div class="card-body">
                <select class="form-select" id="customer-select">
                    <option value="">Walk-in Customer</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                    <i class="fas fa-plus me-1"></i>Add New Customer
                </button>
            </div>
        </div>

        <!-- Cart -->
        <div class="card shadow mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Cart</h6>
                <button class="btn btn-warning btn-sm" id="hold-transaction-btn">
                    <i class="fas fa-pause me-1"></i>Hold
                </button>
            </div>
            <div class="card-body">
                <div id="cart-items" style="max-height: 300px; overflow-y: auto;">
                    <!-- Cart items will be populated here -->
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Total:</strong>
                    <strong id="cart-total">$0.00</strong>
                </div>
            </div>
        </div>

        <!-- Payment -->
        <div class="card shadow mb-3">
            <div class="card-header">
                <h6 class="mb-0">Payment</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" id="payment-method">
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="mobile">Mobile Payment</option>
                    </select>
                </div>
                <!-- Amount Received and Change fields are hidden -->
                <!--
                <div class="mb-3" style="display: none;">
                    <label class="form-label">Amount Received</label>
                    <input type="number" class="form-control" id="amount-received" step="0.01" min="0">
                </div>
                <div class="mb-3" style="display: none;">
                    <strong>Change: <span id="change-amount">$0.00</span></strong>
                </div>
                -->
                <button class="btn btn-success w-100" id="complete-sale-btn" disabled>
                    <i class="fas fa-check me-1"></i>Complete Sale
                </button>
            </div>
        </div>

        <!-- Held Transactions -->
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Held Transactions</h6>
                <span class="badge bg-info" id="held-count-badge">{{ held_transactions|length }}</span>
            </div>
            <div class="card-body">
                <div id="held-transactions-list" style="max-height: 200px; overflow-y: auto;">
                    {% for held in held_transactions %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <small class="fw-bold">{{ held.transaction_id }}</small><br>
                            <small class="text-muted">{{ held.created_at.strftime('%H:%M') }}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-success resume-btn" data-transaction-id="{{ held.transaction_id }}">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-held-btn" data-transaction-id="{{ held.transaction_id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if held_transactions|length == 0 %}
                <p class="text-muted text-center mb-0">No held transactions</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-customer-form">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-customer-btn">Save Customer</button>
            </div>
        </div>
    </div>
</div>

<!-- Hold Transaction Modal -->
<div class="modal fade" id="holdTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hold Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="hold-transaction-form">
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Add any notes for this held transaction..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-hold-btn">Hold Transaction</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    let cart = [];
    let currentCustomer = null;
    let autoSaveInterval;
    let isOnline = navigator.onLine;

    // Load cart from LocalStorage on page load (silent restoration)
    loadCartFromStorage();

    // Check if we should show held transactions modal
    const pageData = $('#page-data');
    const action = pageData.data('action');
    const hasHeld = pageData.data('has-held') === 'true';

    if (action === 'show_held' && hasHeld) {
        setTimeout(function() {
            $('#heldTransactionsModal').modal('show');
        }, 500); // Small delay to ensure modal is ready
    }

    // Auto-save cart every 30 seconds
    autoSaveInterval = setInterval(function() {
        if (cart.length > 0) {
            saveCartToStorage();
            if (isOnline) {
                autoSaveToDatabase();
            }
        }
    }, 30000);

    // Monitor online/offline status
    window.addEventListener('online', function() {
        isOnline = true;
        console.log('Back online - syncing data...');
        if (cart.length > 0) {
            autoSaveToDatabase();
        }
        showOnlineStatus('Back Online', 'success');
    });

    window.addEventListener('offline', function() {
        isOnline = false;
        console.log('Gone offline - using local storage');
        showOnlineStatus('Offline Mode', 'warning');
    });

    // Warn before closing/leaving page
    window.addEventListener('beforeunload', function(e) {
        if (cart.length > 0) {
            saveCartToStorage(); // Final save to LocalStorage
            // Don't show browser's default dialog - we handle this with our custom notifications
            // e.returnValue = ''; // This would show the browser dialog
            // return ''; // This would also show the browser dialog
        }
    });

    // Save cart to LocalStorage
    function saveCartToStorage() {
        try {
            const cartData = {
                cart: cart,
                customer: currentCustomer,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('pos_cart', JSON.stringify(cartData));
            console.log('Cart saved to LocalStorage');
        } catch (e) {
            console.error('Failed to save cart to LocalStorage:', e);
        }
    }

    // Load cart from LocalStorage
    function loadCartFromStorage() {
        try {
            const savedData = localStorage.getItem('pos_cart');
            if (savedData) {
                const cartData = JSON.parse(savedData);
                const savedTime = new Date(cartData.timestamp);
                const now = new Date();
                const hoursDiff = (now - savedTime) / (1000 * 60 * 60);

                // Only load if saved within last 24 hours
                if (hoursDiff < 24) {
                    cart = cartData.cart || [];
                    currentCustomer = cartData.customer;
                    updateCartDisplay();

                    // Silent restoration - no notification shown
                    console.log('Cart silently restored from LocalStorage');

                    console.log('Cart loaded from LocalStorage');
                } else {
                    // Clear old data
                    localStorage.removeItem('pos_cart');
                }
            }
        } catch (e) {
            console.error('Failed to load cart from LocalStorage:', e);
        }
    }

    // Auto-save to database (create held transaction)
    function autoSaveToDatabase() {
        if (cart.length === 0) return;

        // Generate auto-save transaction ID
        const autoSaveId = 'AUTO' + Date.now();

        $.ajax({
            url: '/api/hold_transaction',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                cart: cart,
                customer: currentCustomer,
                notes: 'Auto-saved cart',
                auto_save: true,
                transaction_id: autoSaveId
            }),
            success: function(response) {
                if (response.success) {
                    console.log('Cart auto-saved to database');
                    // Update the auto-saved transaction ID for future updates
                    localStorage.setItem('auto_save_id', autoSaveId);
                }
            },
            error: function(xhr, status, error) {
                console.error('Auto-save failed:', error);
            }
        });
    }

    // Show online/offline status
    function showOnlineStatus(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-warning';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                 style="top: 70px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas fa-${type === 'success' ? 'wifi' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // Remove existing alerts
        $('.alert.position-fixed').remove();

        // Add new alert
        $('body').append(alertHtml);

        // Auto-remove after 5 seconds
        setTimeout(function() {
            $('.alert.position-fixed').fadeOut();
        }, 5000);
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const alertClass = `alert-${type}`;
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
                 style="top: 70px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas fa-info-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // Remove existing alerts
        $('.alert.position-fixed').remove();

        // Add new alert
        $('body').append(alertHtml);

        // Auto-remove after 3 seconds
        setTimeout(function() {
            $('.alert.position-fixed').fadeOut();
        }, 3000);
    }

    // Add to cart functionality
    $('.add-to-cart').click(function() {
        const productId = $(this).data('product-id');
        const productCard = $(this).closest('.product-card');
        const productName = productCard.find('.card-title').text();
        const productPrice = parseFloat(productCard.data('price'));

        addToCart(productId, productName, productPrice);
        updateCartDisplay();
        saveCartToStorage(); // Save immediately when cart changes
    });

    // Hold transaction
    $('#hold-transaction-btn').click(function() {
        if (cart.length === 0) {
            alert('Cart is empty!');
            return;
        }
        $('#holdTransactionModal').modal('show');
    });

    $('#confirm-hold-btn').click(function() {
        const notes = $('#hold-transaction-form textarea[name="notes"]').val();

        $.ajax({
            url: '/api/hold_transaction',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                cart: cart,
                customer: currentCustomer,
                notes: notes
            }),
            success: function(response) {
                if (response.success) {
                    // Clear cart and storage after successful hold
                    cart = [];
                    currentCustomer = null;
                    localStorage.removeItem('pos_cart');
                    localStorage.removeItem('auto_save_id');

                    updateCartDisplay();
                    $('#customer-select').val('');
                    $('#holdTransactionModal').modal('hide');
                    $('#hold-transaction-form')[0].reset();

                    // Show success notification instead of alert
                    showNotification('Transaction held successfully!', 'success');

                    // Refresh page after short delay to show updated notifications
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('Error: ' + response.message, 'error');
                }
            },
            error: function() {
                showNotification('Error holding transaction', 'error');
            }
        });
    });

    // Resume transaction
    $('.resume-btn').click(function() {
        const transactionId = $(this).data('transaction-id');

        $.ajax({
            url: '/api/resume_transaction/' + transactionId,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    cart = response.cart;
                    currentCustomer = response.customer;

                    // Clear any auto-saved data since we're loading from database
                    localStorage.removeItem('pos_cart');
                    localStorage.removeItem('auto_save_id');

                    updateCartDisplay();
                    if (currentCustomer && currentCustomer.id) {
                        $('#customer-select').val(currentCustomer.id);
                    }
                    showNotification('Transaction resumed successfully!', 'success');
                    // Refresh page after short delay to show updated notifications
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error resuming transaction');
            }
        });
    });

    // Delete held transaction
    $('.delete-held-btn').click(function() {
        if (!confirm('Are you sure you want to delete this held transaction?')) {
            return;
        }

        const transactionId = $(this).data('transaction-id');

        $.ajax({
            url: '/api/delete_held_transaction/' + transactionId,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showNotification('Transaction deleted successfully!', 'success');
                    // Refresh page after short delay to show updated notifications
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification('Error: ' + response.message, 'error');
                }
            },
            error: function() {
                alert('Error deleting transaction');
            }
        });
    });

    // Customer selection
    $('#customer-select').change(function() {
        const customerId = $(this).val();
        if (customerId) {
            // Find customer data
            const customerOption = $(this).find('option:selected');
            currentCustomer = {
                id: customerId,
                name: customerOption.text()
            };
        } else {
            currentCustomer = null;
        }
        saveCartToStorage(); // Save when customer changes
    });

    // Payment calculations
    $('#amount-received').on('input', function() {
        const received = parseFloat($(this).val()) || 0;
        const total = getCartTotal();
        const change = received - total;
        $('#change-amount').text('$' + change.toFixed(2));
    });

    // Complete sale
    $('#complete-sale-btn').click(function() {
        if (cart.length === 0) {
            showNotification('Cart is empty!', 'warning');
            return;
        }

        const paymentMethod = $('#payment-method').val();
        const total = getCartTotal();

        // Create transaction data
        const transactionData = {
            customer_id: currentCustomer ? currentCustomer.id : null,
            total_amount: total,
            payment_method: paymentMethod,
            items: cart.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity,
                unit_price: item.price,
                total: item.price * item.quantity
            }))
        };

        // Send transaction to server (you would implement this endpoint)
        console.log('Transaction data:', transactionData);

        // Show success message
        showNotification('Sale completed successfully! Total: $' + total.toFixed(2), 'success');

        // Clear cart and storage
        cart = [];
        currentCustomer = null;
        localStorage.removeItem('pos_cart');
        localStorage.removeItem('auto_save_id');

        updateCartDisplay();
        $('#customer-select').val('');
    });

    // Helper functions
    function addToCart(productId, name, price) {
        const existingItem = cart.find(item => item.product_id === productId);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({
                product_id: productId,
                name: name,
                price: price,
                quantity: 1
            });
        }
    }

    function updateCartDisplay() {
        const cartItemsContainer = $('#cart-items');
        cartItemsContainer.empty();

        if (cart.length === 0) {
            cartItemsContainer.html('<p class="text-muted text-center">Cart is empty</p>');
            $('#complete-sale-btn').prop('disabled', true);
            $('#hold-transaction-btn').prop('disabled', true);
            return;
        }

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            const itemHtml = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small class="text-muted">$${item.price.toFixed(2)} x ${item.quantity}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-2">$${itemTotal.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            cartItemsContainer.append(itemHtml);
        });

        $('#cart-total').text('$' + getCartTotal().toFixed(2));
        $('#complete-sale-btn').prop('disabled', false);
        $('#hold-transaction-btn').prop('disabled', false);

        // Remove item functionality
        $('.remove-item').click(function() {
            const index = $(this).data('index');
            cart.splice(index, 1);
            updateCartDisplay();
            saveCartToStorage(); // Save when item is removed
        });
    }

    function getCartTotal() {
        return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    }

    // Product search with server-side functionality
    let searchTimeout;
    $('#product-search').on('input', function() {
        const searchTerm = $(this).val().trim();
        clearTimeout(searchTimeout);

        searchTimeout = setTimeout(function() {
            // Update URL with search parameter
            const url = new URL(window.location);
            if (searchTerm) {
                url.searchParams.set('search', searchTerm);
            } else {
                url.searchParams.delete('search');
            }

            // Reload page with search parameter
            window.location.href = url.toString();
        }, 300); // Debounce search by 300ms
    });

    // Clear search
    $('#clear-search').click(function() {
        $('#product-search').val('');
        const url = new URL(window.location);
        url.searchParams.delete('search');
        window.location.href = url.toString();
    });

    // Search button click
    $('#search-btn').click(function() {
        const searchTerm = $('#product-search').val().trim();
        const url = new URL(window.location);
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
        } else {
            url.searchParams.delete('search');
        }
        window.location.href = url.toString();
    });

    // Enter key support
    $('#product-search').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            $('#search-btn').click();
        }
    });

    // Add customer
    $('#save-customer-btn').click(function() {
        const formData = new FormData(document.getElementById('add-customer-form'));
        const customerData = Object.fromEntries(formData);

        // Here you would send the data to the server to create a new customer
        alert('Customer added successfully!');
        $('#addCustomerModal').modal('hide');
        $('#add-customer-form')[0].reset();
        // You might want to refresh the customer list here
    });

    // Update count every 30 seconds
    setInterval(updateHeldTransactionsCount, 30000);

    // Update count when page loads
    document.addEventListener('DOMContentLoaded', updateHeldTransactionsCount);

    // Save data when page becomes hidden (user switches tabs)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && cart.length > 0) {
            saveCartToStorage();
            console.log('Page hidden - cart saved to LocalStorage');
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+S to manually save
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            if (cart.length > 0) {
                saveCartToStorage();
                showNotification('Cart saved manually', 'success');
            }
        }

        // Ctrl+H to hold transaction
        if (e.ctrlKey && e.key === 'h') {
            e.preventDefault();
            if (cart.length > 0) {
                $('#hold-transaction-btn').click();
            }
        }
    });

    // Clear auto-save interval when page unloads
    window.addEventListener('unload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
});
</script>
{% endblock %}